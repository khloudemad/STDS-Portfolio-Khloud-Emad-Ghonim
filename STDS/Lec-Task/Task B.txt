# Transformation Layer: Business Rules & Logic

The transformation phase applies a sequence of data science-driven rules to address inconsistent units, missing values, inefficient formats, and basic fault detection. Rules are designed to be idempotent, traceable, and focused on producing high-quality data for downstream analytics (peak detection, forecasting, anomaly monitoring).

### Rule 1: Unit Standardization
If the reported unit is "W" (Watts), divide the energy value by 1000 and update the unit to "kW" (Kilowatts). If already in "kW", leave unchanged.  
Add a metadata flag: unit_converted: true/false.  
*Rationale*: Ensures consistent scale across all records, preventing aggregation errors in peak consumption analysis.

### Rule 2: Handling Missing Values
If the energy reading is NULL or missing:  
- Flag the record with missing_value: true.  
- Exclude from immediate aggregate calculations (e.g., peak usage).  
- For gaps < 1 hour, apply forward-fill from the last valid reading (same meter).  
- For larger gaps, leave as NULL and log for further investigation.  
*Rationale*: Preserves time-series continuity where reasonable while avoiding artificial imputation bias in forecasting models.

### Rule 3: Data Validation & Outlier Detection
Validate post-standardized values:  
- Flag if kW > 10 (unrealistic for typical household) or kW < 0 (invalid).  
- Compute rolling z-score over a 24-hour window per meter; flag if |z-score| > 3 as outlier.  
Invalid or outlier records are routed to error queue for retry or manual review.  
*Rationale*: Removes gross errors that could skew statistical models and analytics.

### Rule 4: Basic Faulty Meter Detection
Track consecutive near-zero readings (< 0.01 kW) per meter:  
- If > 24 consecutive hours of near-zero, mark meter as potentially_faulty and flag all related records.  
- If daily total consumption = 0 for > 3 consecutive days, trigger operational alert.  
*Rationale*: Early heuristic-based detection of meter failures using time-series patterns, preparing data for advanced ML-based fault prediction.

### Rule 5: Timestamp Normalization & Deduplication
- Convert all timestamps to UTC.  
- Ensure monotonic increasing order per meter.  
- If duplicate (same meter_id + timestamp), retain the most recent value and flag duplicate_resolved: true.  
*Rationale*: Guarantees accurate temporal alignment critical for time-based analytics and forecasting.

*Additional Controls*:
- Log pre- and post-transformation statistics (e.g., % missing, % converted, % flagged).
- All flags stored as metadata columns for auditability and downstream filtering.
